---
title: Python：celery队列
date: 2022-12-10 10:35:04
tags: 
- Python
- MQ
categories: Python面试题
cover: https://images.unsplash.com/photo-1666543257223-095dcc9a12fd
---

## Celery简介

#### 1. 什么是任务队列

任务队列是一种用于在线程或计算机之间分配工作的机制。

任务队列的输入是一个称为任务的工作单元，有专门的职程（**Worker**）进行不断的监视任务队列，进行执行新的任务工作。

Celery 通过消息机制进行通信，通常使用中间件（**Broker**）作为客户端和职程（**Worker**）调节。启动一个任务，客户端向消息队列发送一条消息，然后中间件（**Broker**）将消息传递给一个职程（**Worker**），最后由职程（**Worker**）执行。

Celery 可以有多个职程（Worker）和中间件（Broker），用来提高Celery的高可用性以及横向扩展能力。

Celery 需要消息中间件来进行发送和接收消息。 RabbitMQ 和 Redis 中间件的功能比较齐全，但也支持其它的实验性的解决方案，其 中包括 SQLite 进行本地开发。

Celery 可以在一台机器上运行，也可以在多台机器上运行，甚至可以跨数据中心运行。

#### 2. Celery组件

**Celery 扮演生产者和消费者的角色**

- Celery Beat：任务调度器。Beat 进程会读取配置文件的内容，周期性的将配置中到期需要执行的任务发送给任务队列。

- Celery Worker：执行任务的消费者，通常会在多台服务器运行多个消费者，提高运行效率。

- Broker：消息代理，队列本身。 也称为消息中间件。 接受任务生产者发送过来的任务消息，存进队列再按序分发给任务消费方(通常是消息队列或者数据库)。

- Producer：任务生产者。 调用 Celery API ，函数或者装饰器，而产生任务并交给任务队列处理的都是任务生产者。

- Result Backend : 任务处理完成之后保存状态信息和结果，以供查询。

**celery架构图**

![](https://pic3.zhimg.com/80/v2-5beea41170db3f01ea379bc1e6520bda_720w.webp)

#### 3. Celery特点

- **高可用**

当任务执行失败或执行过程中发生连接中断，celery 会自动尝试重新执行任务。

- **快速**

一个单进程的 Celery 每分钟可以处理数以百万的任务，而且延迟仅为亚毫秒（使用 RabbitMQ、 librabbitmq 在优化过后）。

- **灵活**

Celery 的每个部分几乎都可以自定义扩展和单独使用，例如自定义连接池、序列化方式、压缩方式、日志记录方式、任务调度、生产者、消费者、中间件（Broker）等。

### 4. Celery功能

- **监控**

可以针对整个流程进行监控，内置的工具可以实时说明当前集群的概况。

- **调度**

可以通过调度功能在一段时间内指定任务的执行时间 datetime，也可以根据简单每隔一段时间进行执行重复的任务，支持分钟、小时、星期几，也支持某一天或某一年的Crontab表达式。

- **工作流**

可以通过“canvas”进行组成工作流，其中包含分组、链接、分块等等。

简单和复杂的工作流程可以使用一组“canvas“组成，其中包含分组、链接、分块等。

- **资源（内存）泄漏保护**

--max-tasks-per-child 参数适用于可能会出现资源泄漏（例如：内存泄漏）的任务。

- **时间和速率的限制**

您可以控制每秒/分钟/小时执行任务的次数，或者任务执行的最长时间，也将这些设置为默认值，针对特定的任务或程序进行定制化配置。

- **自定义组件**

开发者可以定制化每一个职程（Worker）以及额外的组件。职程（Worker）是用 “bootsteps” 构建的-一个依赖关系图，可以对职程（Worker）的内部进行细粒度控制。

#### 5. 版本要求

Celery 4.0 运行：

- Python ❨2.7,3.4,3.5❩  

- PyPy ❨5.4,5.5❩  

这是支持 Python2.7 的最后一个版本，从下一个版本Celery5.x开始，需要Python3.5或更高的版本。

如果您的 Python 运行环境比较老，则需要使用旧版本的Celery：

- Python 2.6：Celery 3.1 或更早版本。
- Python 2.5：Celery 3.0 或更早版本。
- Python 2.4：Celery 2.2 或更早版本。

### 参考文章

- [Celery 分布式任务队列 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/337138573?utm_id=0)
